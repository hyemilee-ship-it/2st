
import React, { useState, useEffect } from 'react';
import { LayoutDashboard, Calendar, BarChart3, Plus, Edit3, Save, Trash2, CheckCircle2, Clock } from 'lucide-react';
import Dashboard from './components/Dashboard';
import ScheduleTable from './components/ScheduleTable';
import Analytics from './components/Analytics';
import CalendarView from './components/CalendarView';
import { Episode, ProcessType, PROCESS_ORDER } from './types';

const STORAGE_KEY = 'webtoon-pd-scheduler-v1';
const PROJECT_NAME_KEY = 'webtoon-pd-project-name';

type TabType = 'dashboard' | 'calendar' | 'schedule' | 'analytics';

const App: React.FC = () => {
  const [activeTab, setActiveTab] = useState<TabType>('dashboard');
  const [projectName, setProjectName] = useState(() => localStorage.getItem(PROJECT_NAME_KEY) || '나의 웹툰 프로젝트');
  const [isEditingName, setIsEditingName] = useState(false);
  
  const [episodes, setEpisodes] = useState<Episode[]>(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    return saved ? JSON.parse(saved) : [];
  });

  const [isSaving, setIsSaving] = useState(false);

  useEffect(() => {
    setIsSaving(true);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(episodes));
    localStorage.setItem(PROJECT_NAME_KEY, projectName);
    const timer = setTimeout(() => setIsSaving(false), 500);
    return () => clearTimeout(timer);
  }, [episodes, projectName]);

  const updateEpisodeDate = (episodeId: string, process: ProcessType, type: 'draft' | 'fixed', value: string) => {
    setEpisodes(prev => prev.map(ep => {
      if (ep.id === episodeId) {
        return {
          ...ep,
          processes: { 
            ...ep.processes, 
            [process]: { ...ep.processes[process], [type === 'draft' ? 'draftDate' : 'fixedDate']: value } 
          }
        };
      }
      return ep;
    }));
  };

  const addNewEpisode = () => {
    const lastEp = episodes.length > 0 ? episodes[episodes.length - 1] : null;
    const newNumber = lastEp ? lastEp.number + 1 : 1;
    const newEp: Episode = {
      id: `ep-${Date.now()}`,
      number: newNumber,
      title: `${newNumber}화`,
      processes: PROCESS_ORDER.reduce((acc, p) => ({ ...acc, [p]: { draftDate: '', fixedDate: '' } }), {} as any)
    };
    setEpisodes([...episodes, newEp]);
  };

  const deleteEpisode = (episodeId: string) => {
    if (window.confirm('정말로 이 회차를 삭제하시겠습니까?')) {
      setEpisodes(prev => prev.filter(ep => ep.id !== episodeId));
    }
  };

  return (
    <div className="flex h-screen bg-slate-50 overflow-hidden font-sans">
      {/* Sidebar */}
      <aside className="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0">
        <div className="p-6 border-b border-slate-100">
          <div className="flex items-center gap-3 mb-1">
            <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">W</div>
            <h1 className="font-bold text-slate-800 tracking-tight">Webtoon PD</h1>
          </div>
          <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Scheduler v1.0</p>
        </div>

        <nav className="flex-1 p-4 space-y-1">
          {[
            { id: 'dashboard', icon: LayoutDashboard, label: '대시보드' },
            { id: 'calendar', icon: Calendar, label: '마감 캘린더' },
            { id: 'schedule', icon: BarChart3, label: '공정 관리표' },
            { id: 'analytics', icon: BarChart3, label: '성과 분석' }
          ].map((item) => (
            <button
              key={item.id}
              onClick={() => setActiveTab(item.id as TabType)}
              className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-semibold text-sm ${
                activeTab === item.id 
                ? 'bg-indigo-50 text-indigo-700 shadow-sm' 
                : 'text-slate-500 hover:bg-slate-50 hover:text-slate-800'
              }`}
            >
              <item.icon size={18} />
              {item.label}
            </button>
          ))}
        </nav>

        <div className="p-4 border-t border-slate-100">
          <div className="bg-slate-50 rounded-xl p-4">
             <div className="flex items-center justify-between mb-1">
               <span className="text-[10px] font-bold text-slate-400 uppercase">Status</span>
               <div className={`w-2 h-2 rounded-full ${isSaving ? 'bg-amber-400 animate-pulse' : 'bg-emerald-500'}`}></div>
             </div>
             <p className="text-xs font-bold text-slate-700">{isSaving ? '저장 중...' : '모든 데이터 저장됨'}</p>
          </div>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col overflow-hidden">
        <header className="h-16 bg-white border-b border-slate-200 px-8 flex items-center justify-between shrink-0">
          <div className="flex items-center gap-4">
            {isEditingName ? (
              <input
                autoFocus
                className="font-bold text-slate-800 border-b-2 border-indigo-500 outline-none px-1"
                value={projectName}
                onChange={(e) => setProjectName(e.target.value)}
                onBlur={() => setIsEditingName(false)}
                onKeyDown={(e) => e.key === 'Enter' && setIsEditingName(false)}
              />
            ) : (
              <div className="flex items-center gap-2 group cursor-pointer" onClick={() => setIsEditingName(true)}>
                <h2 className="font-bold text-slate-800">{projectName}</h2>
                <Edit3 size={14} className="text-slate-300 group-hover:text-indigo-500 transition-colors" />
              </div>
            )}
          </div>

          <button 
            onClick={addNewEpisode}
            className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm transition-all active:scale-95 text-sm font-bold"
          >
            <Plus size={18} />
            새 회차 추가
          </button>
        </header>

        <div className="flex-1 overflow-y-auto p-8 custom-scrollbar">
          <div className="max-w-7xl mx-auto">
            {activeTab === 'dashboard' && <Dashboard episodes={episodes} />}
            {activeTab === 'calendar' && <CalendarView episodes={episodes} />}
            {activeTab === 'schedule' && <ScheduleTable episodes={episodes} onUpdate={updateEpisodeDate} onDelete={deleteEpisode} />}
            {activeTab === 'analytics' && <Analytics episodes={episodes} />}
          </div>
        </div>
      </main>
    </div>
  );
};

export default App;
